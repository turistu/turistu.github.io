<!DOCTYPE HTML>
<html lang=en>
<title>a simple TOTP generator</title>
<meta charset=utf-8>
<meta name=viewport content=width=device-width,initial-scale=1>
<style>
#error { font-weight: bold; color: red; display: block; height: 1em }
#key:invalid { background-color: red; color: pink }
#code { font-family: monospace; font-size: 250%; letter-spacing: .15em }
#code::after { all: initial; content: ' ' attr(title); color: red }
#code[title^=copied]::after { color: green }

input, button { font-size: inherit }
#user, #key { box-sizing: border-box; width: 100%; max-width: 25em }
button { max-width: max-content }
#add { display: none }

.popup *, .popup ~ * { display: none }
.popup #user, .popup #code { all: revert }
.popup #user { display: block; margin: .5em 0 }
.popup #code::after { font-size: 80% }
.popup #add { display: inline; float: right }
</style>

<form>
  <label for=user>User</label><br>
  <input id=user size=24 autocomplete=username>
  <p>
    <label for=key>Shared Key</label>
    <label><input type=checkbox id=show>show</label><br>
    <input id=key size=24 autocomplete=current-password type=password pattern="[a-zA-Z2-7\s]+">
    <output for=key id=error></output>
  </p>
  <output for=key id=code>XXXXXX</output>
  <a id=add href target=_blank>add key</a>
  <p><button type=button id=generate>Generate TOTP (and copy it to clipboard)</button>
  <p><button>Save the key (with the browser's password manager)</button>
</form>

<p>The TOTP shared key should be in base32 format, e.g. <code>TK7P33KPE527ZTOX</code> (github) or <code>opid zgaw quda ip7q tj3z izo7 oemp t7dm</code> (google).

<p>The <q>User</q> field is not used for computing the TOTP; its only purpose is to act as a label for the password manager.

<p>If the <q>Save..</q> button does not pop up the <q>Save login/password</q> dialog, look for a key-like icon in the address bar or password input box and click on it. If there's no such icon, check if your browser's settings prevent it from saving passwords on this page.
<hr>
<p>This is a javascript implementation of
a <a href=https://www.rfc-editor.org/rfc/rfc6238>TOTP</a> generator,
using the browser's
<a href=https://w3c.github.io/webcrypto/#subtlecrypto-interface>crypto API</a>.
It should do the exactly same thing as the google authenticator or any other
TOTP generating app.

<p>The <a href=#source>javascript code</a> does not send to or fetch any data
from anywhere remotely, and
the <a href=https://turistu.github.io/totp.html>demo page</a>
should work the same when served over https, saved locally or used inside
a browser extension.

<p>I have also packaged this into an <a href=https://addons.mozilla.org/en-US/firefox/addon/totp/>xpi firefox browser extension</a>,
which offers the convenience of generating the TOTP (for a key you have saved)
directly from a toolbar popup instead of having to switch to another tab.
The xpi does not do anything more than that and does not include any content
scripts or filters.
<script>
function qs(s){ return document.querySelector(s) }
async function generate(){
	try {
		qs('#code').value = await totp(qs('#key').value);
		copy('click to copy');
	}catch(e){
		qs('#key').setCustomValidity(e);
		qs('#error').value = 'ERROR: ' + e;
	}
}
async function copy(emsg){
	try {
		await navigator.clipboard.writeText(qs('#code').value);
		if(!matchMedia('(pointer:coarse)').matches)
			getSelection().selectAllChildren(qs('#code'));
		qs('#code').title = 'copied!';
	}catch(e){
		qs('#code').title = emsg;
	}
}
qs('#generate').onclick = generate;
qs('#key').oninput = function(){
	this.setCustomValidity('');
	qs('#error').value = this.checkValidity() ?
		'' : 'ERROR: only A..Z, 2..7 and spaces allowed';
	if(this !== document.activeElement) generate();
}
qs('#show').checked = false;
qs('#show').onchange = function(){
	qs('#key').type = this.checked ? 'text': 'password';
}
qs('#code').onclick = e => copy('copy failed');
qs('form').className = document.location.hash.substr(1);
qs('form').onsubmit = e => e.preventDefault();
if(window.PasswordCredential){
	// chrome, edge
	qs('form').onsubmit = function(e){
		navigator.credentials.store(new PasswordCredential({
			id: qs('#user').value, password: qs('#key').value
		}));
		e.preventDefault();
	}
}else if(!/Gecko\/\d/.test(navigator.userAgent)){
	// firefox doesn't need this kludge
	qs('form').onsubmit = null;
	let iframe = document.createElement('iframe');
	iframe.style.display = 'none';
	qs('form').target = iframe.name = 'fram';
	document.body.appendChild(iframe);
}
</script>
<script id=source style="display: block; white-space: pre; font-family: monospace; overflow: auto">
async function totp(key, secs = 30, digits = 6){
	return hotp(unbase32(key), pack64bu(Date.now() / 1000 / secs), digits);
}
async function hotp(key, counter, digits){
	let y = window.crypto.subtle;
	if(!y) throw 'no window.crypto.subtle object available';
	let k = await y.importKey('raw', key, {name: 'HMAC', hash: 'SHA-1'}, false, ['sign']);
	return hotp_truncate(await y.sign('HMAC', k, counter), digits);
}
function hotp_truncate(buf, digits){
	let a = new Uint8Array(buf), i = a[19] & 0xf;
	return fmt(10, digits, ((a[i]&0x7f)<<24 | a[i+1]<<16 | a[i+2]<<8 | a[i+3]) % 10**digits);
}

function fmt(base, width, num){
	return num.toString(base).padStart(width, '0')
}
function unbase32(s){
	let t = (s.toLowerCase().match(/\S/g)||[]).map(c => {
		let i = 'abcdefghijklmnopqrstuvwxyz234567'.indexOf(c);
		if(i < 0) throw `bad char '${c}' in key`;
		return fmt(2, 5, i);
	}).join('');
	if(t.length < 8) throw 'key too short';
	return new Uint8Array(t.match(/.{8}/g).map(d => parseInt(d, 2)));
}
function pack64bu(v){
	let b = new ArrayBuffer(8), d = new DataView(b);
	d.setUint32(0, v / 2**32);
	d.setUint32(4, v);
	return b;
}
</script>
